$version = "v.2.2"
                
$nodes_QA01_ALL =
                "lsiqa01ssbs02.lsi-qa.ad",
                "lsiqa01ssbs03.lsi-qa.ad",
                "lsiqa01sdoc01.lsi-qa.ad",
                "lsiqa01sdoc03.lsi-qa.ad",
                "lsiqa01sdoc04.lsi-qa.ad"
                
$nodes_QA01 = 
                "lsiqa01ssbs02.lsi-qa.ad",
                "lsiqa01ssbs03.lsi-qa.ad",
                "lsiqa01ssbs04.lsi-qa.ad"
                
$nodes_QA01_DOCSVC =
                "lsiqa01sdoc01.lsi-qa.ad",
                "lsiqa01sdoc03.lsi-qa.ad",
                "lsiqa01sdoc04.lsi-qa.ad"

$nodes_QA02_ALL =
                "lsiqa02ssbs01.lsi-qa.ad",
                "lsiqa02ssbs02.lsi-qa.ad",
                "lsiqa02ssbs03.lsi-qa.ad",
                "lsiqa02ssbs11.lsi-qa.ad",
                "lsiqa02ssbs12.lsi-qa.ad",
                "lsiqa02ssbs13.lsi-qa.ad"
                
$nodes_QA02 =
                "lsiqa02ssbs01.lsi-qa.ad",
                "lsiqa02ssbs02.lsi-qa.ad",
                "lsiqa02ssbs03.lsi-qa.ad",
                "lsiqa02ssbs11.lsi-qa.ad",
                "lsiqa02ssbs12.lsi-qa.ad",
                "lsiqa02ssbs13.lsi-qa.ad"

$nodes_QA03_ALL =
                "lsiqa03ssbs01.lsi-qa.ad",
                "lsiqa03ssbs02.lsi-qa.ad",
                "lsiqa03ssbs03.lsi-qa.ad",
                "lsiqa03ssbs04.lsi-qa.ad",
                "lsiqa03ssbs05.lsi-qa.ad",
                "lsiqa03ssbs06.lsi-qa.ad"
                
$nodes_QA03 =
                "lsiqa03ssbs01.lsi-qa.ad",
                "lsiqa03ssbs02.lsi-qa.ad",
                "lsiqa03ssbs03.lsi-qa.ad"

$nodes_QA04_ALL =      
                "lsiqa04ssbs01.lsi-qa.ad",
                "lsiqa04ssbs02.lsi-qa.ad",
                "lsiqa04ssbs03.lsi-qa.ad"
                
$nodes_QA04 =
                "lsiqa04ssbs01.lsi-qa.ad",
                "lsiqa04ssbs02.lsi-qa.ad",
                "lsiqa04ssbs03.lsi-qa.ad"

$nodes_INT01_ALL =
                "lsiint01ssbs01.lsi-qa.ad"
                
$nodes_INT01 =
                "lsiint01ssbs01.lsi-qa.ad"

$nodes_INT02_ALL =     
                "lsiint02ssbs01.lsi-qa.ad"
                
$nodes_INT02 =
                "lsiint02ssbs01.lsi-qa.ad"

$nodes_REC01_ALL =     
                "lsirec01ssbs01.lsi-qa.ad",
                "lsirec01ssbs02.lsi-qa.ad"
                
$nodes_REC01 =
                "lsirec01ssbs01.lsi-qa.ad",
                "lsirec01ssbs02.lsi-qa.ad"

$nodes_STG01_ALL =
                "lsistg01ssbs01.lsi-stg.ad",
                "lsistg01ssbs02.lsi-stg.ad",
                "lsistg01ssbs101.lsi-stg.ad",
                "lsistg01ssbs102.lsi-stg.ad",
                "lsistg01ssbs201.lsi-stg.ad",
                "lsistg01ssbs202.lsi-stg.ad",
                "lsistg01ssbs301.lsi-stg.ad",
                "lsistg01ssbs302.lsi-stg.ad"

$nodes_STG01 =
                "lsistg01ssbs01.lsi-stg.ad",
                "lsistg01ssbs02.lsi-stg.ad"

$nodes_STG01_ELSAMP =
                "lsistg01ssbs101.lsi-stg.ad",
                "lsistg01ssbs102.lsi-stg.ad"

$nodes_STG01_SMT =
                "lsistg01ssbs01.lsi-stg.ad",
                "lsistg01ssbs02.lsi-stg.ad"
                
$nodes_STG01_AT =
                "lsistg01ssbs01.lsi-stg.ad",
                "lsistg01ssbs02.lsi-stg.ad"             
                
$nodes_STG01_AQC =
                "lsistg01ssbs201.lsi-stg.ad",
                "lsistg01ssbs202.lsi-stg.ad"

$nodes_PROD_ALL =
                "lsisna01ssbs101.lsi-fnf.net",
                "lsisna01ssbs102.lsi-fnf.net",
                "lsisna01ssbs103.lsi-fnf.net",
                "lsisna01ssbs104.lsi-fnf.net",
                "lsisna01ssbs201.lsi-fnf.net",
                "lsisna01ssbs202.lsi-fnf.net",
                "lsisna01ssbs203.lsi-fnf.net",
                "lsisna01ssbs204.lsi-fnf.net",
                "lsisna01ssbs301.lsi-fnf.net",
                "lsisna01ssbs302.lsi-fnf.net",
                "lsisna01ssbs303.lsi-fnf.net",
                "lsisna01ssbs304.lsi-fnf.net",
                "lsisna01ssbs401.lsi-fnf.net",
                "lsisna01ssbs402.lsi-fnf.net",
                "lsisna01ssbs403.lsi-fnf.net",
                "lsisna01ssbs405.lsi-fnf.net",
                "lsisna01sdoc01.lsi-fnf.net",
                "lsisna01sdoc02.lsi-fnf.net",
                "lsisna01sdoc03.lsi-fnf.net",
                "lsisna01sdoc04.lsi-fnf.net",
                "lsisna01sdoc05.lsi-fnf.net"
                
$nodes_PROD =
                "lsisna01ssbs401.lsi-fnf.net",
                "lsisna01ssbs402.lsi-fnf.net",
                "lsisna01ssbs403.lsi-fnf.net",
                "lsisna01ssbs404.lsi-fnf.net"

$nodes_PROD_ELSAMP =
                "lsisna01ssbs101.lsi-fnf.net",
                "lsisna01ssbs102.lsi-fnf.net",
                "lsisna01ssbs103.lsi-fnf.net",
                "lsisna01ssbs104.lsi-fnf.net"

$nodes_PROD_CLS =
                "lsisna01ssbs301.lsi-fnf.net",
                "lsisna01ssbs302.lsi-fnf.net",
                "lsisna01ssbs303.lsi-fnf.net",
                "lsisna01ssbs304.lsi-fnf.net"

$nodes_PROD_SMT =
                "lsisna01ssbs01.lsi-fnf.net",
                "lsisna01ssbs02.lsi-fnf.net",
                "lsisna01ssbs03.lsi-fnf.net",
                "lsisna01ssbs04.lsi-fnf.net"

$nodes_PROD_AT =
                "lsisna01ssbs201.lsi-fnf.net",
                "lsisna01ssbs202.lsi-fnf.net",
                "lsisna01ssbs203.lsi-fnf.net",
                "lsisna01ssbs204.lsi-fnf.net"

$nodes_PROD_AQC =
                "lsisna01ssbs201.lsi-fnf.net",
                "lsisna01ssbs202.lsi-fnf.net",
                "lsisna01ssbs203.lsi-fnf.net",
                "lsisna01ssbs204.lsi-fnf.net"

$nodes_PROD_DOCSVC =
                "lsisna01sdoc01.lsi-fnf.net",
                "lsisna01sdoc02.lsi-fnf.net",
                "lsisna01sdoc03.lsi-fnf.net",
                "lsisna01sdoc04.lsi-fnf.net",
                "lsisna01sdoc05.lsi-fnf.net"
                
$order_all_up =
                "PubSub",
                "Configuration",
                "ServiceHost"

$order_all_down =
                "ServiceHost",
                "Configuration",
                "PubSub"

$order_config_up =
                "PubSub",
                "Configuration"

$order_config_down =
                "Configuration",
                "PubSub"

$order_servicehost =
                "ServiceHost"
                
                
$lb = "-----------------------------------------------------------------------------"

function env_menu()
{
                cls
                
                write-host ""
                write-host "  ServiceBus Tool" $version -fore darkgray
                write-host ""
                $lb
                write-host ""
                write-host "     1  -  QA01"
                write-host "     2  -  QA02"
                write-host "     3  -  QA03"
                write-host "     4  -  QA04"
                write-host ""
                write-host "     5  -  INT01"
                write-host "     6  -  INT02"
                write-host "     7  -  REC01"
                write-host ""
                write-host "     S  -  STG01"
                write-host "     P  -  PRODUCTION"
                write-host ""
                write-host ""
                write-host "     X  -  EXIT"
                write-host ""
                $lb
                write-host ""
                $sel_env = read-host "  Select Environment"
                
                switch($sel_env)
                {
                                "1" {$nodelist = $nodes_QA01; $env = "QA01"}
                                "2" {$nodelist = $nodes_QA02; $env = "QA02"}
                                "3" {$nodelist = $nodes_QA03; $env = "QA03"}
                                "4" {$nodelist = $nodes_QA04; $env = "QA04"}
                                "5" {$nodelist = $nodes_INT01; $env = "INT01"}
                                "6" {$nodelist = $nodes_INT02; $env = "INT02"}
                                "7" {$nodelist = $nodes_REC01; $env = "REC01"}
                                "S" {$nodelist = $nodes_STG01; $env = "STG01"}
                                "P" {$nodelist = $nodes_PROD; $env = "PRODUCTION"}
                                "X" {call_exit}
                                default {env_menu}
                }
                
                write-host ""
                $sel_inst = read-host "  Instance Name ( or 'ALL' ) "
                
                if($sel_env -eq "1" -and $sel_inst -eq "DOCSVC")
                {
                                $nodelist = $nodes_QA01_DOCSVC
                }
                elseif($sel_env -eq "P" -and $sel_inst -eq "DOCSVC")
                {
                                $nodelist = $nodes_PROD_DOCSVC
                }
                elseif($sel_env -eq "S" -and $sel_inst -eq "ELSAMP")
                {
                                $nodelist = $nodes_STG01_ELSAMP
                }
                elseif($sel_env -eq "P" -and $sel_inst -eq "ELSAMP")
                {
                                $nodelist = $nodes_PROD_ELSAMP
                }
                elseif($sel_env -eq "S" -and $sel_inst -eq "SMT")
                {
                                $nodelist = $nodes_STG01_SMT
                }
                elseif($sel_env -eq "P" -and $sel_inst -eq "SMT")
                {
                                $nodelist = $nodes_PROD_SMT
                }
                elseif($sel_env -eq "S" -and $sel_inst -eq "CLS")
                {
                                $nodelist = $nodes_STG01_CLS
                }
                elseif($sel_env -eq "P" -and $sel_inst -eq "CLS")
                {
                                $nodelist = $nodes_PROD_CLS
                }
                elseif($sel_env -eq "S" -and $sel_inst -eq "AT")
                {
                                $nodelist = $nodes_STG01_AT
                }
                elseif($sel_env -eq "P" -and $sel_inst -eq "AT")
                {
                                $nodelist = $nodes_PROD_AT
                }
                elseif($sel_env -eq "S" -and $sel_inst -eq "AQC")
                {
                                $nodelist = $nodes_STG01_AQC
                }
                elseif($sel_env -eq "P" -and $sel_inst -eq "AQC")
                {
                                $nodelist = $nodes_PROD_AQC
                }
                elseif($sel_env -eq "1" -and $sel_inst -eq "ALL")
                {
                                $nodelist = $nodes_QA01_ALL
                }
                elseif($sel_env -eq "2" -and $sel_inst -eq "ALL")
                {
                                $nodelist = $nodes_QA02_ALL
                }
                elseif($sel_env -eq "3" -and $sel_inst -eq "ALL")
                {
                                $nodelist = $nodes_QA03_ALL
                }
                elseif($sel_env -eq "3" -and $sel_inst -eq "ALL")
                {
                                $nodelist = $nodes_QA03_ALL
                }              
                elseif($sel_env -eq "4" -and $sel_inst -eq "ALL")
                {
                                $nodelist = $nodes_QA04_ALL
                }
                elseif($sel_env -eq "5" -and $sel_inst -eq "ALL")
                {
                                $nodelist = $nodes_INT01_ALL
                }
                elseif($sel_env -eq "6" -and $sel_inst -eq "ALL")
                {
                                $nodelist = $nodes_INT02_ALL
                }
                elseif($sel_env -eq "7" -and $sel_inst -eq "ALL")
                {
                                $nodelist = $nodes_REC01_ALL
                }
                elseif($sel_env -eq "S" -and $sel_inst -eq "ALL")
                {
                                $nodelist = $nodes_STG01_ALL
                }              
                elseif($sel_env -eq "P" -and $sel_inst -eq "ALL")
                {
                                $nodelist = $nodes_PROD_ALL
                }
                
                switch($sel_inst)
                {
                                "ALL" {$inst = "ALL"}
                                "" {env_menu}
                                default {$inst = $sel_inst.ToUpper()}
                }
                
                task_menu -nodelist $nodelist -env $env -inst $inst
}

function task_menu($nodelist, $env, $inst)
{
                write-host ""
                $lb
                write-host ""
                write-host "     C  -  Check Service Status"
                write-host "     F  -  Open Cache-Files Folders"
                write-host ""
                write-host "     1  -  Stop Config/PubSub Services"
                write-host "     2  -  Start Config/PubSub Services"
                write-host ""
                write-host "     3  -  Stop ServiceHost Services"
                write-host "     4  -  Start ServiceHost Services"
                write-host ""
                write-host "     D  -  Stop ALL Services"
                write-host "     U  -  Start ALL Services"
                write-host ""
                write-host "     N  -  Select New Environment"
                write-host "     X  -  EXIT"
                write-host ""
                $lb
                write-host ""
                $sel_task = read-host "  Select Task"
                
                switch($sel_task)
                {
                                "C" {$task = "C"; $service_order = $order_all_up; $action = "CHECK status of services"}
                                "F" {$task = "F"; $service_order = "NONE"; $action = "OPEN cache-files folders"}
                                "1" {$task = "D"; $service_order = $order_config_down; $action = "STOP Config/PubSub services"}
                                "2" {$task = "U"; $service_order = $order_config_up; $action = "START Config/PubSub services"}
                                "3" {$task = "D"; $service_order = $order_servicehost; $action = "STOP ServiceHost services"}
                                "4" {$task = "U"; $service_order = $order_servicehost; $action = "START ServiceHost services"}
                                "D" {$task = "D"; $service_order = $order_all_down; $action = "STOP ALL ServiceBus services"}
                                "U" {$task = "U"; $service_order = $order_all_up; $action = "START ALL ServiceBus services"}
                                "N" {env_menu}
                                "X" {call_exit}
                                default {task_menu}
                }
                
                call_confirm -nodelist $nodelist -env $env -inst $inst -task $task -action $action -service_order $service_order
}

function call_confirm($nodelist, $env, $inst, $task, $action, $service_order)
{
                cls
                write-host ""
                $lb
                write-host ""
                write-host ""
                write-host "     Environment:  " $env -fore yellow
                write-host ""
                write-host "     SB Instance:  " $inst -fore yellow
                write-host ""
                write-host "     Task Action:  " $action -fore yellow
                write-host ""
                write-host ""
                $lb
                write-host ""
                $confirm = read-host "  Please Confirm (Y/N)"
                
                switch($confirm)
                {
                                "Y" {call_action -nodelist $nodelist -env $env -inst $inst -task $task -service_order $service_order}
                                "N" {task_menu -nodelist $nodelist -env $env -inst $inst -task $task -action $action -service_order $service_order}
                                default {call_confirm -nodelist $nodelist -env $env -inst $inst -task $task -action $action -service_order $service_order}
                }
}

function call_action($nodelist, $env, $inst, $task, $service_order)
{
                $output = @{e={$_.null};width=6},
                  @{e={$_.name};width=38},
                  @{e={$_.startmode};width=12},
                  @{e={$_.state};width=12}
                
                foreach($node in $nodelist)
                {
                                write-host ""
                                $lb
                                write-host ""
                                write-host " " $node
                                write-host ""
                                write-host ""
                                
                                if($task -eq "F")
                                {
                                                write-host "  Opening cache-files folder..." -fore cyan
                                                
                                                try
                                                {
                                                                invoke-item \\$node\c$\ServiceBus\ServiceBus$inst\ServiceHost\ServiceBus.ServicePools -ErrorAction Stop
                                                }
                                                
                                                catch
                                                {
                                                                try
                                                                {
                                                                                invoke-item \\$node\c$\ServiceBus\$inst\ServiceHost\ServiceBus.ServicePools -ErrorAction Stop
                                                                }
                                                                
                                                                catch
                                                                {
                                                                                try
                                                                                {
                                                                                                invoke-item \\$node\c$\ServiceBus$inst\ServiceHost\ServiceBus.ServicePools -ErrorAction Stop
                                                                                }
                                                                                
                                                                                catch
                                                                                {
                                                                                                write-host ""
                                                                                                write-host "  ...Folder path cannot be found..." -fore red
                                                                                }
                                                                }
                                                }
                                }
                                
                                if($service_order -ne "NONE")
                                {
                                                foreach($service in $service_order)
                                                {
                                                                if($inst -eq "ALL"){$svc_query = "name like 'ServiceBus " + $service + "%'"}
                                                                                else{$svc_query = "name like 'ServiceBus " + $service + " (" + $inst + ")'"}
                                                                
                                                                $svc_cmd = gwmi win32_service -filter $svc_query -computername $node
                                                                $svc_up = $svc_cmd | where {$_.startmode -ne 'disabled' -and $_.state -ne 'running' -and $_.state -ne 'start pending'}
                                                                $svc_down = $svc_cmd | where {$_.state -ne 'stopped' -and $_.state -ne 'stop pending'}
                                                                
                                                                switch($task)
                                                                {
                                                                                "C"
                                                                                {
                                                                                                $svc_cmd | ft -hide $output
                                                                                }
                                                                                
                                                                                "U"
                                                                                {                                                                              
                                                                                                switch($service)
                                                                                                {
                                                                                                                "PubSub"
                                                                                                                {
                                                                                                                                if($svc_up -ne $null)
                                                                                                                                {
                                                                                                                                                $svc_up.startservice() | out-null
                                                                                                                                }
                                                                                                                }
                                                                                                                
                                                                                                                "Configuration"
                                                                                                                {
                                                                                                                                $dep = (get-service "ServiceBus PubSub*" -computername $node).status
                                                                                                                                
                                                                                                                                if($dep -eq "running")
                                                                                                                                {
                                                                                                                                                if($svc_up -ne $null)
                                                                                                                                                {
                                                                                                                                                                $svc_up.startservice() | out-null
                                                                                                                                                }
                                                                                                                                }
                                                                                                                }
                                                                                                                
                                                                                                                "ServiceHost"
                                                                                                                {
                                                                                                                                if($svc_up -ne $null)
                                                                                                                                {
                                                                                                                                                $svc_up.startservice() | out-null
                                }

                                if ($inst -eq "ELSAMP")  {Start-Sleep -Seconds 30}
                                
                                                                                                                }
                                                                                                                
                                                                                                                default
                                                                                                                {
                                                                                                                
                                                                                                                }
                                                                                                }
                                                                                }
                                                                                
                                                                                "D"
                                                                                {
                                                                                                if($svc_down -ne $null)
                                                                                                {
                                                                                                                $svc_down.stopservice() | out-null
                                                                                                }
                                                                                }
                                                                                
                                                                                default
                                                                                {
                                                                                                write-host ""
                                                                                                $lb
                                                                                                write-host "An error has occurred..." -fore red
                                                                                                call_exit
                                                                                }
                                                                }
                                                }
                                }
                                
                                if($task -eq "U")
                                {
                                                write-host "START command sent..." -fore green
                                                write-host ""
                                }
                                elseif ($task -eq "D")
                                {
                                                write-host "STOP command sent..." -fore red
                                                write-host ""
                                }
                }
                
                task_menu -nodelist $nodelist -env $env -inst $inst
}

function call_exit()
{
                write-host ""
                $lb
                write-host ""
                write-host "  Good-Bye..." -fore yellow
                write-host ""
                write-host ""
                exit
}


cls
env_menu
